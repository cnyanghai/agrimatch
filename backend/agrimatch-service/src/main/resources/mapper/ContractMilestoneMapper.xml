<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.agrimatch.contract.mapper.ContractMilestoneMapper">

    <resultMap id="MilestoneMap" type="com.agrimatch.contract.domain.BusContractMilestone">
        <id column="id" property="id"/>
        <result column="contract_id" property="contractId"/>
        <result column="milestone_type" property="milestoneType"/>
        <result column="milestone_name" property="milestoneName"/>
        <result column="description" property="description"/>
        <result column="expected_date" property="expectedDate"/>
        <result column="actual_date" property="actualDate"/>
        <result column="operator_user_id" property="operatorUserId"/>
        <result column="evidence_url" property="evidenceUrl"/>
        <result column="evidence_json" property="evidenceJson"/>
        <result column="remark" property="remark"/>
        <result column="status" property="status"/>
        <result column="confirm_user_id" property="confirmUserId"/>
        <result column="confirm_time" property="confirmTime"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="vehicle_info_json" property="vehicleInfoJson"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <insert id="insert" parameterType="com.agrimatch.contract.domain.BusContractMilestone"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO bus_contract_milestone
        (contract_id, milestone_type, milestone_name, description, expected_date, sort_order, vehicle_info_json, status, is_deleted, create_time, update_time)
        VALUES
        (#{contractId}, #{milestoneType}, #{milestoneName}, #{description}, #{expectedDate}, #{sortOrder}, #{vehicleInfoJson}, 'pending', 0, NOW(3), NOW(3))
    </insert>

    <select id="selectById" resultMap="MilestoneMap">
        SELECT * FROM bus_contract_milestone
        WHERE id = #{id} AND is_deleted = 0
        LIMIT 1
    </select>

    <select id="selectByContractId" resultMap="MilestoneMap">
        SELECT * FROM bus_contract_milestone
        WHERE contract_id = #{contractId} AND is_deleted = 0
        ORDER BY sort_order ASC, create_time ASC
    </select>

    <update id="submit">
        UPDATE bus_contract_milestone
        SET status = 'submitted',
            operator_user_id = #{operatorUserId},
            actual_date = #{actualDate},
            evidence_url = #{evidenceUrl},
            evidence_json = #{evidenceJson},
            remark = #{remark},
            update_time = NOW(3)
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <update id="confirm">
        UPDATE bus_contract_milestone
        SET status = 'confirmed',
            confirm_user_id = #{confirmUserId},
            confirm_time = NOW(3),
            update_time = NOW(3)
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <update id="reject">
        UPDATE bus_contract_milestone
        SET status = 'rejected',
            confirm_user_id = #{confirmUserId},
            confirm_time = NOW(3),
            remark = #{remark},
            update_time = NOW(3)
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <update id="logicalDelete">
        UPDATE bus_contract_milestone
        SET is_deleted = 1, update_time = NOW(3)
        WHERE id = #{id} AND is_deleted = 0
    </update>

    <select id="countPendingByContractId" resultType="int">
        SELECT COUNT(*) FROM bus_contract_milestone
        WHERE contract_id = #{contractId} AND status IN ('pending', 'submitted') AND is_deleted = 0
    </select>

</mapper>

