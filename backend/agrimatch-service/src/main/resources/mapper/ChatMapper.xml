<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.agrimatch.chat.mapper.ChatMapper">

    <resultMap id="MsgMap" type="com.agrimatch.chat.domain.BusChatMessage">
        <id column="id" property="id"/>
        <result column="conversation_id" property="conversationId"/>
        <result column="from_user_id" property="fromUserId"/>
        <result column="to_user_id" property="toUserId"/>
        <result column="from_user_name" property="fromUserName"/>
        <result column="from_nick_name" property="fromNickName"/>
        <result column="to_user_name" property="toUserName"/>
        <result column="to_nick_name" property="toNickName"/>
        <result column="msg_type" property="msgType"/>
        <result column="content" property="content"/>
        <result column="payload_json" property="payloadJson"/>
        <result column="quote_status" property="quoteStatus"/>
        <result column="basis_price" property="basisPrice"/>
        <result column="contract_code" property="contractCode"/>
        <result column="is_read" property="isRead"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <insert id="insertMessage" parameterType="com.agrimatch.chat.domain.BusChatMessage"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO bus_chat_message
        (conversation_id, from_user_id, to_user_id, msg_type, content, payload_json, quote_status, basis_price, contract_code, is_read, is_deleted, create_time, update_time)
        VALUES
        (#{conversationId}, #{fromUserId}, #{toUserId}, #{msgType}, #{content}, #{payloadJson}, #{quoteStatus}, #{basisPrice}, #{contractCode}, 0, 0, NOW(3), NOW(3))
    </insert>

    <select id="selectMessageById" resultMap="MsgMap">
        SELECT
            m.id, m.conversation_id, m.from_user_id, m.to_user_id,
            fu.user_name AS from_user_name,
            fu.nick_name AS from_nick_name,
            tu.user_name AS to_user_name,
            tu.nick_name AS to_nick_name,
            m.msg_type, m.content, m.payload_json, m.quote_status, m.basis_price, m.contract_code, m.is_read, m.is_deleted, m.create_time, m.update_time
        FROM bus_chat_message m
        LEFT JOIN sys_user fu ON fu.user_id = m.from_user_id AND fu.del_flag = '0'
        LEFT JOIN sys_user tu ON tu.user_id = m.to_user_id AND tu.del_flag = '0'
        WHERE m.id = #{id}
    </select>

    <select id="selectHistory" resultMap="MsgMap">
        SELECT
            m.id, m.conversation_id, m.from_user_id, m.to_user_id,
            fu.user_name AS from_user_name,
            fu.nick_name AS from_nick_name,
            tu.user_name AS to_user_name,
            tu.nick_name AS to_nick_name,
            m.msg_type, m.content, m.payload_json, m.quote_status, m.basis_price, m.contract_code, m.is_read, m.is_deleted, m.create_time, m.update_time
        FROM bus_chat_message m
        LEFT JOIN sys_user fu ON fu.user_id = m.from_user_id AND fu.del_flag = '0'
        LEFT JOIN sys_user tu ON tu.user_id = m.to_user_id AND tu.del_flag = '0'
        WHERE m.is_deleted = 0
          AND ((m.from_user_id = #{a} AND m.to_user_id = #{b})
            OR (m.from_user_id = #{b} AND m.to_user_id = #{a}))
        ORDER BY m.create_time DESC, m.id DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <update id="updateQuoteStatus">
        UPDATE bus_chat_message
        SET quote_status = #{status},
            update_time = NOW(3)
        WHERE id = #{id}
          AND is_deleted = 0
    </update>

    <update id="expireOldQuotes">
        UPDATE bus_chat_message
        SET quote_status = 'EXPIRED',
            update_time = NOW(3)
        WHERE conversation_id = #{conversationId}
          AND msg_type = 'QUOTE'
          AND quote_status = 'OFFERED'
          AND id != #{exceptId}
          AND is_deleted = 0
    </update>

    <update id="markReadFromPeer">
        UPDATE bus_chat_message
        SET is_read = 1,
            update_time = NOW(3)
        WHERE to_user_id = #{toUserId}
          AND from_user_id = #{fromUserId}
          AND is_deleted = 0
          AND is_read = 0
    </update>

    <select id="selectPeers" resultType="com.agrimatch.chat.mapper.ChatMapper$PeerRow">
        SELECT
            t.peer_user_id AS peerUserId,
            pu.user_name AS peerUserName,
            pu.nick_name AS peerNickName,
            pc.company_name AS peerCompanyName,
            t.last_content AS lastContent,
            t.last_time AS lastTime,
            IFNULL(u.unread_count, 0) AS unreadCount
        FROM (
            SELECT peer_user_id,
                   SUBSTRING_INDEX(GROUP_CONCAT(content ORDER BY create_time DESC SEPARATOR '\n'), '\n', 1) AS last_content,
                   MAX(create_time) AS last_time
            FROM (
                SELECT CASE WHEN from_user_id = #{userId} THEN to_user_id ELSE from_user_id END AS peer_user_id,
                       content,
                       create_time
                FROM bus_chat_message
                WHERE is_deleted = 0
                  AND (from_user_id = #{userId} OR to_user_id = #{userId})
            ) x
            GROUP BY peer_user_id
        ) t
        LEFT JOIN (
            SELECT from_user_id AS peer_user_id, COUNT(1) AS unread_count
            FROM bus_chat_message
            WHERE to_user_id = #{userId}
              AND is_deleted = 0
              AND is_read = 0
            GROUP BY from_user_id
        ) u ON u.peer_user_id = t.peer_user_id
        LEFT JOIN sys_user pu ON pu.user_id = t.peer_user_id AND pu.del_flag = '0'
        LEFT JOIN bus_company pc ON pc.id = pu.company_id AND (pc.is_deleted IS NULL OR pc.is_deleted = 0)
        ORDER BY t.last_time DESC
    </select>

    <select id="selectConversationId" resultType="long">
        SELECT id
        FROM bus_chat_conversation
        WHERE is_deleted = 0
          AND a_user_id = #{aUserId}
          AND b_user_id = #{bUserId}
          AND subject_type = #{subjectType}
          AND subject_id = #{subjectId}
        LIMIT 1
    </select>

    <insert id="insertConversation" parameterType="com.agrimatch.chat.domain.BusChatConversation"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO bus_chat_conversation
        (a_user_id, b_user_id, subject_type, subject_id, subject_snapshot_json, last_msg_id, last_content, last_time, is_deleted, create_time, update_time)
        VALUES
        (#{aUserId}, #{bUserId}, #{subjectType}, #{subjectId}, #{subjectSnapshotJson}, NULL, NULL, NULL, 0, NOW(3), NOW(3))
    </insert>
    
    <select id="selectConversationById" resultType="com.agrimatch.chat.domain.BusChatConversation">
        SELECT id, a_user_id AS aUserId, b_user_id AS bUserId, 
               subject_type AS subjectType, subject_id AS subjectId, 
               subject_snapshot_json AS subjectSnapshotJson,
               last_msg_id AS lastMsgId, last_content AS lastContent, last_time AS lastTime,
               is_deleted AS isDeleted, create_time AS createTime, update_time AS updateTime
        FROM bus_chat_conversation
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <update id="updateConversationSnapshot">
        UPDATE bus_chat_conversation
        SET subject_snapshot_json = #{subjectSnapshotJson},
            update_time = NOW(3)
        WHERE id = #{id}
          AND is_deleted = 0
    </update>

    <update id="updateConversationLast">
        UPDATE bus_chat_conversation
        SET last_msg_id = #{lastMsgId},
            last_content = #{lastContent},
            last_time = NOW(3),
            update_time = NOW(3)
        WHERE id = #{id}
          AND is_deleted = 0
    </update>

    <select id="selectConversations" resultType="com.agrimatch.chat.mapper.ChatMapper$ConversationRow">
        SELECT
            t.id,
            t.peer_user_id AS peerUserId,
            pu.user_name AS peerUserName,
            pu.nick_name AS peerNickName,
            pc.company_name AS peerCompanyName,
            t.subject_type AS subjectType,
            t.subject_id AS subjectId,
            t.subject_snapshot_json AS subjectSnapshotJson,
            t.last_content AS lastContent,
            t.last_time AS lastTime,
            IFNULL(u.unread_count, 0) AS unreadCount
        FROM (
            SELECT
                c.*,
                CASE WHEN c.a_user_id = #{userId} THEN c.b_user_id ELSE c.a_user_id END AS peer_user_id
            FROM bus_chat_conversation c
            WHERE c.is_deleted = 0
              AND (c.a_user_id = #{userId} OR c.b_user_id = #{userId})
        ) t
        LEFT JOIN sys_user pu ON pu.user_id = t.peer_user_id AND pu.del_flag = '0'
        LEFT JOIN bus_company pc ON pc.id = pu.company_id AND (pc.is_deleted IS NULL OR pc.is_deleted = 0)
        LEFT JOIN (
            SELECT conversation_id, COUNT(1) AS unread_count
            FROM bus_chat_message
            WHERE to_user_id = #{userId}
              AND is_deleted = 0
              AND is_read = 0
              AND conversation_id IS NOT NULL
            GROUP BY conversation_id
        ) u ON u.conversation_id = t.id
        ORDER BY t.last_time DESC, t.id DESC
    </select>

    <select id="selectConversationMessages" resultMap="MsgMap">
        SELECT
            m.id, m.conversation_id, m.from_user_id, m.to_user_id,
            fu.user_name AS from_user_name,
            fu.nick_name AS from_nick_name,
            tu.user_name AS to_user_name,
            tu.nick_name AS to_nick_name,
            m.msg_type, m.content, m.payload_json, m.quote_status, m.basis_price, m.contract_code, m.is_read, m.is_deleted, m.create_time, m.update_time
        FROM bus_chat_message m
        LEFT JOIN sys_user fu ON fu.user_id = m.from_user_id AND fu.del_flag = '0'
        LEFT JOIN sys_user tu ON tu.user_id = m.to_user_id AND tu.del_flag = '0'
        WHERE m.is_deleted = 0
          AND m.conversation_id = #{conversationId}
        ORDER BY m.create_time DESC, m.id DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <update id="markReadInConversation">
        UPDATE bus_chat_message
        SET is_read = 1,
            update_time = NOW(3)
        WHERE conversation_id = #{conversationId}
          AND to_user_id = #{toUserId}
          AND is_deleted = 0
          AND is_read = 0
    </update>

    <select id="selectConversationUserPair" resultType="com.agrimatch.chat.mapper.ChatMapper$ConversationUserPair">
        SELECT a_user_id AS aUserId,
               b_user_id AS bUserId
        FROM bus_chat_conversation
        WHERE id = #{conversationId}
          AND is_deleted = 0
        LIMIT 1
    </select>

    <!-- 更新消息的 payloadJson -->
    <update id="updateMessagePayload">
        UPDATE bus_chat_message
        SET payload_json = #{payloadJson},
            update_time = NOW(3)
        WHERE id = #{id}
          AND is_deleted = 0
    </update>

    <!-- 根据合同ID查找CONTRACT类型消息 -->
    <select id="selectContractMessageByContractId" resultMap="MsgMap">
        SELECT
            m.id, m.conversation_id, m.from_user_id, m.to_user_id,
            fu.user_name AS from_user_name,
            fu.nick_name AS from_nick_name,
            tu.user_name AS to_user_name,
            tu.nick_name AS to_nick_name,
            m.msg_type, m.content, m.payload_json, m.quote_status, m.basis_price, m.contract_code, m.is_read, m.is_deleted, m.create_time, m.update_time
        FROM bus_chat_message m
        LEFT JOIN sys_user fu ON fu.user_id = m.from_user_id AND fu.del_flag = '0'
        LEFT JOIN sys_user tu ON tu.user_id = m.to_user_id AND tu.del_flag = '0'
        WHERE m.is_deleted = 0
          AND m.msg_type = 'CONTRACT'
          AND m.payload_json LIKE CONCAT('%"contractId":', #{contractId}, '%')
        ORDER BY m.create_time DESC
        LIMIT 1
    </select>

</mapper>


