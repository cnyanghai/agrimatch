<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.agrimatch.post.mapper.PostMapper">

    <resultMap id="PostMap" type="com.agrimatch.post.domain.BusPost">
        <id column="id" property="id"/>
        <result column="company_id" property="companyId"/>
        <result column="user_id" property="userId"/>
        <result column="company_name" property="companyName"/>
        <result column="user_name" property="userName"/>
        <result column="nick_name" property="nickName"/>
        <result column="position" property="position"/>
        <result column="avatar" property="avatar"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="domain" property="domain"/>
        <result column="tags_json" property="tagsJson"/>
        <result column="images_json" property="imagesJson"/>
        <result column="post_type" property="postType"/>
        <result column="is_paid" property="isPaid"/>
        <result column="price" property="price"/>
        <result column="teaser_length" property="teaserLength"/>
        <result column="is_expert" property="isExpert"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <insert id="insert" parameterType="com.agrimatch.post.domain.BusPost"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO bus_post
        (company_id, user_id, title, content, domain, tags_json, images_json, post_type, 
         is_paid, price, teaser_length, is_expert,
         is_deleted, create_time, update_time)
        VALUES
        (#{companyId}, #{userId}, #{title}, #{content}, #{domain}, #{tagsJson}, #{imagesJson}, #{postType}, 
         #{isPaid}, #{price}, #{teaserLength}, #{isExpert},
         0, NOW(3), NOW(3))
    </insert>

    <select id="selectById" resultMap="PostMap">
        SELECT
            p.id, p.company_id, p.user_id,
            c.company_name AS company_name,
            u.user_name AS user_name,
            u.nick_name AS nick_name,
            u.position AS position,
            u.avatar AS avatar,
            p.title, p.content, p.domain, p.tags_json, p.images_json,
            p.post_type, p.is_paid, p.price, p.teaser_length, p.is_expert,
            p.is_deleted, p.create_time, p.update_time
        FROM bus_post p
        LEFT JOIN bus_company c ON c.id = p.company_id AND (c.is_deleted IS NULL OR c.is_deleted = 0)
        LEFT JOIN sys_user u ON u.user_id = p.user_id AND u.del_flag = '0'
        WHERE p.id = #{id}
          AND p.is_deleted = 0
        LIMIT 1
    </select>

    <select id="selectList" resultMap="PostMap">
        SELECT
            p.id, p.company_id, p.user_id,
            c.company_name AS company_name,
            u.user_name AS user_name,
            u.nick_name AS nick_name,
            u.position AS position,
            u.avatar AS avatar,
            p.title, p.content, p.domain, p.tags_json, p.images_json,
            p.post_type, p.is_paid, p.price, p.teaser_length, p.is_expert,
            p.is_deleted, p.create_time, p.update_time
        FROM bus_post p
        LEFT JOIN bus_company c ON c.id = p.company_id AND (c.is_deleted IS NULL OR c.is_deleted = 0)
        LEFT JOIN sys_user u ON u.user_id = p.user_id AND u.del_flag = '0'
        <!-- hot_7d 热度：近 N 天内的点赞/评论计数（仅用于排序，不返回到 domain） -->
        <if test="q != null and q.orderBy == 'hot_7d'">
            LEFT JOIN (
                SELECT post_id, COUNT(1) AS cnt
                FROM bus_post_like
                WHERE is_deleted = 0
                  AND create_time &gt;= DATE_SUB(NOW(3), INTERVAL #{q.recentDays} DAY)
                GROUP BY post_id
            ) pl ON pl.post_id = p.id
            LEFT JOIN (
                SELECT post_id, COUNT(1) AS cnt
                FROM bus_post_comment
                WHERE is_deleted = 0
                  AND create_time &gt;= DATE_SUB(NOW(3), INTERVAL #{q.recentDays} DAY)
                GROUP BY post_id
            ) pc ON pc.post_id = p.id
        </if>
        <where>
            p.is_deleted = 0
            <if test="q != null and q.domain != null and q.domain != ''">
                AND p.domain = #{q.domain}
            </if>
            <if test="q != null and q.orderBy == 'hot_7d' and q.recentDays != null">
                AND p.create_time &gt;= DATE_SUB(NOW(3), INTERVAL #{q.recentDays} DAY)
            </if>
            <if test="q != null and q.companyId != null">
                AND p.company_id = #{q.companyId}
            </if>
            <if test="q != null and q.userId != null">
                AND p.user_id = #{q.userId}
            </if>
            <if test="q != null and q.keyword != null and q.keyword != ''">
                AND (p.title LIKE CONCAT('%', #{q.keyword}, '%')
                OR p.content LIKE CONCAT('%', #{q.keyword}, '%'))
            </if>
            <if test="q != null and q.postType != null and q.postType != ''">
                AND p.post_type = #{q.postType}
            </if>
            <if test="q != null and q.followingUserId != null">
                AND p.user_id IN (SELECT follow_user_id FROM bus_user_follow WHERE user_id = #{q.followingUserId})
            </if>
            <if test="q != null and q.onlyCollected and q.viewerUserId != null">
                AND p.id IN (SELECT post_id FROM bus_post_collect WHERE user_id = #{q.viewerUserId})
            </if>
        </where>
        ORDER BY
        <choose>
            <when test="q != null and q.orderBy == 'hot_7d'">
                (IFNULL(pl.cnt, 0) + IFNULL(pc.cnt, 0)) DESC,
                p.create_time
            </when>
            <when test="q != null and q.orderBy == 'create_time'">
                p.create_time
            </when>
            <otherwise>
                p.create_time
            </otherwise>
        </choose>
        <choose>
            <when test="q != null and q.order == 'asc'">ASC</when>
            <otherwise>DESC</otherwise>
        </choose>
        <if test="q != null and q.limit != null and q.limit &gt; 0">
            LIMIT #{q.limit}
        </if>
    </select>

    <update id="logicalDelete">
        UPDATE bus_post
        SET is_deleted = 1,
            update_time = NOW(3)
        WHERE id = #{id}
          AND is_deleted = 0
    </update>

</mapper>


