<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.agrimatch.map.mapper.MapCompanyMapper">

    <select id="selectCompanyMarkers" resultType="com.agrimatch.map.mapper.MapCompanyMapper$Row">
        SELECT
            c.id AS companyId,
            c.company_name AS companyName,
            c.address AS address,
            c.lat AS lat,
            c.lng AS lng,
            IFNULL(s.cnt, 0) AS supplyCount,
            IFNULL(r.cnt, 0) AS requirementCount,
            s.cats AS supplyCats,
            r.cats AS requirementCats,
            c.update_time AS updateTime
        FROM bus_company c
        LEFT JOIN (
            SELECT company_id,
                   COUNT(1) AS cnt,
                   GROUP_CONCAT(DISTINCT category_name ORDER BY category_name SEPARATOR ',') AS cats
            FROM bus_supply
            WHERE is_deleted = 0
            GROUP BY company_id
        ) s ON s.company_id = c.id
        LEFT JOIN (
            SELECT company_id,
                   COUNT(1) AS cnt,
                   GROUP_CONCAT(DISTINCT category_name ORDER BY category_name SEPARATOR ',') AS cats
            FROM bus_requirement
            WHERE is_deleted = 0
              AND (expire_time IS NULL OR expire_time &gt; NOW(3))
            GROUP BY company_id
        ) r ON r.company_id = c.id
        WHERE c.is_deleted = 0
        <if test="keyword != null and keyword != ''">
            AND (c.company_name LIKE CONCAT('%', #{keyword}, '%')
            OR c.address LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY c.update_time DESC, c.id DESC
    </select>

</mapper>





