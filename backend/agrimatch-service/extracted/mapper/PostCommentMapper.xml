<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.agrimatch.post_social.mapper.PostCommentMapper">

    <resultMap id="CommentMap" type="com.agrimatch.post_social.domain.BusPostComment">
        <id column="id" property="id"/>
        <result column="post_id" property="postId"/>
        <result column="company_id" property="companyId"/>
        <result column="user_id" property="userId"/>
        <result column="company_name" property="companyName"/>
        <result column="user_name" property="userName"/>
        <result column="nick_name" property="nickName"/>
        <result column="content" property="content"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <insert id="insert" parameterType="com.agrimatch.post_social.domain.BusPostComment"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO bus_post_comment
        (post_id, company_id, user_id, content, is_deleted, create_time, update_time)
        VALUES
        (#{postId}, #{companyId}, #{userId}, #{content}, 0, NOW(3), NOW(3))
    </insert>

    <select id="selectByPostId" resultMap="CommentMap">
        SELECT
            pc.id, pc.post_id, pc.company_id, pc.user_id,
            c.company_name AS company_name,
            u.user_name AS user_name,
            u.nick_name AS nick_name,
            pc.content, pc.is_deleted, pc.create_time, pc.update_time
        FROM bus_post_comment pc
        LEFT JOIN bus_company c ON c.id = pc.company_id AND c.is_deleted = 0
        LEFT JOIN sys_user u ON u.user_id = pc.user_id AND u.is_deleted = 0
        WHERE pc.post_id = #{postId}
          AND pc.is_deleted = 0
        ORDER BY pc.create_time ASC, pc.id ASC
    </select>

    <select id="countByPostId" resultType="int">
        SELECT COUNT(1)
        FROM bus_post_comment
        WHERE post_id = #{postId}
          AND is_deleted = 0
    </select>

    <select id="countByPostIds" resultType="com.agrimatch.post_social.mapper.PostCommentMapper$PostIdCountRow">
        SELECT post_id AS postId, COUNT(1) AS cnt
        FROM bus_post_comment
        WHERE is_deleted = 0
          <if test="postIds != null and postIds.size() &gt; 0">
            AND post_id IN
            <foreach collection="postIds" item="pid" open="(" close=")" separator=",">
                #{pid}
            </foreach>
          </if>
        GROUP BY post_id
    </select>

</mapper>


