import React, { useState, useEffect, useCallback, useRef } from 'react';
import { Shield, CheckCircle, Lock, RefreshCcw, FileText, Award } from 'lucide-react';

/**
 * 1. 核心业务 Hook (逻辑层)
 * 封装了所有关于拖拽、位置计算和签署状态转换的业务逻辑
 */
const useSealSignature = () => {
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const [isSigned, setIsSigned] = useState(false);
  const [signingStatus, setSigningStatus] = useState('idle'); // 'idle' | 'processing' | 'completed'
  const dragStartPos = useRef({ x: 0, y: 0 });

  // 处理拖拽开始
  const handleDragStart = useCallback((e) => {
    if (isSigned) return;
    setIsDragging(true);
    
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    
    dragStartPos.current = {
      x: clientX - position.x,
      y: clientY - position.y
    };
  }, [isSigned, position.x, position.y]);

  // 处理拖拽过程
  const handleDragMove = useCallback((e) => {
    if (!isDragging || isSigned) return;
    
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    setPosition({
      x: clientX - dragStartPos.current.x,
      y: clientY - dragStartPos.current.y
    });
  }, [isDragging, isSigned]);

  // 处理拖拽结束
  const handleDragEnd = useCallback(() => {
    setIsDragging(false);
  }, []);

  // 模拟 CA 签署流程
  const performSignature = useCallback(async () => {
    if (isSigned || signingStatus === 'processing') return;
    
    setSigningStatus('processing');
    
    // 模拟异步 CA 认证与 Hash 锁定
    await new Promise(resolve => setTimeout(resolve, 1800));
    
    setIsSigned(true);
    setSigningStatus('completed');
  }, [isSigned, signingStatus]);

  // 重置
  const reset = () => {
    setPosition({ x: 0, y: 0 });
    setIsSigned(false);
    setSigningStatus('idle');
  };

  return {
    position,
    isDragging,
    isSigned,
    signingStatus,
    handleDragStart,
    handleDragMove,
    handleDragEnd,
    performSignature,
    reset
  };
};

/**
 * 2. 表现层组件 (UI 层)
 * 纯粹的视图渲染，不包含复杂的业务逻辑计算
 */
export default function App() {
  const {
    position,
    isDragging,
    isSigned,
    signingStatus,
    handleDragStart,
    handleDragMove,
    handleDragEnd,
    performSignature,
    reset
  } = useSealSignature();

  return (
    <div 
      className="min-h-screen bg-slate-100 p-4 md:p-8 font-sans select-none"
      onMouseMove={handleDragMove}
      onMouseUp={handleDragEnd}
      onTouchMove={handleDragMove}
      onTouchEnd={handleDragEnd}
    >
      <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        {/* 合同主展示区 */}
        <div className="lg:col-span-3 bg-white shadow-2xl rounded-sm border border-gray-200 relative overflow-hidden min-h-[900px] p-12 md:p-20">
          
          {/* 背景水印 */}
          <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.03] rotate-45 text-9xl font-black">
            CONFIDENTIAL
          </div>

          {/* 合同内容 */}
          <div className="relative z-10">
            <header className="text-center mb-16">
              <h1 className="text-3xl font-bold text-gray-900 border-b-2 border-gray-900 inline-block pb-2">
                电子贸易购销协议
              </h1>
              <div className="mt-4 text-xs text-gray-400 font-mono flex justify-center gap-4">
                <span>流水号: TS-20241230-01</span>
                <span>存证哈希: SHA256:77E...F12</span>
              </div>
            </header>

            <article className="space-y-6 text-gray-700 leading-relaxed text-sm">
              <section>
                <h2 className="font-bold text-gray-900 mb-2">一、合作背景</h2>
                <p>甲乙双方经友好协商，就大宗煤炭采购事宜达成一致。双方确认使用具备法律效力的第三方 CA 电子证书进行合同签署。</p>
              </section>

              <section className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r">
                <p className="italic text-blue-800">
                  注：本合同符合《电子签名法》要求，一旦签署，文档内容将被数字摘要技术锁定，任何篡改都将导致签名失效。
                </p>
              </section>

              <section>
                <h2 className="font-bold text-gray-900 mb-2">二、违约责任</h2>
                <p>如任何一方违反协议条款，应赔偿对方由此产生的全部直接及间接经济损失。</p>
              </section>
            </article>

            {/* 签署印章区域 */}
            <div className="mt-40 grid grid-cols-2 gap-12 border-t border-gray-100 pt-10">
              {/* 甲方区域 (固定) */}
              <div className="relative h-40 border-r border-gray-50">
                <span className="text-xs font-bold text-gray-400 block mb-4">甲方 (签署人): 智控科技</span>
                <div className="absolute top-0 right-10 opacity-60">
                  <div className="w-24 h-24 border-2 border-red-500 rounded-full flex items-center justify-center text-red-500 font-bold text-[10px] rotate-[-12deg]">
                    <div className="text-center border-y border-red-500 py-1">智控科技<br/>合同专用章</div>
                  </div>
                </div>
              </div>

              {/* 乙方区域 (交互) */}
              <div className="relative h-40">
                <span className="text-xs font-bold text-gray-400 block mb-4">乙方 (签署人): 华夏物贸</span>
                
                {/* 投放参考区 */}
                <div className="absolute inset-0 border-2 border-dashed border-gray-100 rounded-lg flex items-center justify-center -z-0">
                  {!isSigned && <span className="text-[10px] text-gray-300">拖拽印章至此处</span>}
                </div>

                {/* 可拖拽印章 */}
                <div
                  onMouseDown={handleDragStart}
                  onTouchStart={handleDragStart}
                  style={{ 
                    transform: `translate(${position.x}px, ${position.y}px)`,
                    transition: isDragging ? 'none' : 'transform 0.2s cubic-bezier(0.2, 0, 0.2, 1)'
                  }}
                  className={`absolute z-50 left-10 top-0 ${isSigned ? 'cursor-default' : 'cursor-grab active:cursor-grabbing'}`}
                >
                  <div className={`
                    w-28 h-28 border-4 rounded-full flex items-center justify-center transition-all duration-500
                    ${isSigned ? 'border-red-600 text-red-600 bg-red-50/20 rotate-[5deg]' : 'border-red-400 text-red-400 bg-white shadow-xl rotate-[-5deg]'}
                  `}>
                    <div className="text-center">
                      <div className="text-[10px] font-bold px-1 border-b border-red-400 mb-1">华夏物贸有限公司</div>
                      <div className="text-[8px] scale-90">合同专用章</div>
                      <div className="mt-1 text-sm">★</div>
                    </div>
                  </div>
                  {isSigned && (
                    <div className="absolute -bottom-2 -right-2 bg-green-500 text-white rounded-full p-1 shadow-lg border-2 border-white">
                      <Lock size={12} />
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* 右侧控制面板 */}
        <div className="space-y-6">
          <div className="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
            <div className="flex items-center gap-2 mb-6">
              <Shield className="text-blue-600" size={24} />
              <h3 className="font-bold text-lg">签署控制台</h3>
            </div>

            <div className="space-y-6">
              <div>
                <label className="text-[10px] text-gray-400 uppercase font-bold block mb-2">安全状态</label>
                <div className={`
                  flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium
                  ${isSigned ? 'bg-green-50 text-green-700' : 'bg-amber-50 text-amber-700'}
                `}>
                  <div className={`w-2 h-2 rounded-full ${isSigned ? 'bg-green-500' : 'bg-amber-500 animate-pulse'}`} />
                  {isSigned ? '文档已哈希锁定' : '待乙方实名签署'}
                </div>
              </div>

              <div className="space-y-3">
                <button
                  onClick={performSignature}
                  disabled={isSigned || signingStatus === 'processing'}
                  className={`
                    w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all
                    ${isSigned 
                      ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
                      : 'bg-blue-600 text-white hover:bg-blue-700 shadow-lg active:scale-95'}
                  `}
                >
                  {signingStatus === 'processing' ? (
                    <div className="flex items-center gap-2">
                      <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                      正在认证...
                    </div>
                  ) : isSigned ? (
                    <>已存证 <CheckCircle size={18} /></>
                  ) : (
                    <>确认签署 (CA 认证)</>
                  )}
                </button>

                <button 
                  onClick={reset}
                  className="w-full py-2 text-xs text-gray-400 hover:text-gray-600 flex items-center justify-center gap-1"
                >
                  <RefreshCcw size={12} /> 重置练习
                </button>
              </div>
            </div>
          </div>

          {/* 存证信息卡 */}
          <div className="bg-slate-900 rounded-2xl p-6 text-white overflow-hidden relative">
            <div className="relative z-10">
              <h4 className="text-sm font-bold flex items-center gap-2 mb-4">
                <Award size={16} className="text-blue-400" /> 存证信息回执
              </h4>
              <div className="space-y-3 font-mono text-[10px] opacity-70">
                <p>CA_PROVIDER: Entrust_Digital</p>
                <p>AUTH_METHOD: Biometric_Face</p>
                <p>TSA_STAMP: {new Date().toLocaleDateString()}</p>
                <p className="break-all">UUID: {isSigned ? '550e8400-e29b-41d4-a716-446655440000' : 'Pending...'}</p>
              </div>
            </div>
            <FileText className="absolute -right-4 -bottom-4 text-white/5" size={120} />
          </div>
        </div>
      </div>

      {/* 签署成功 Modal */}
      {isSigned && signingStatus === 'completed' && (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
          <div className="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl animate-in zoom-in-95 duration-300">
            <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
              <CheckCircle size={32} />
            </div>
            <h3 className="text-xl font-bold mb-2 text-gray-900">数字化签署成功</h3>
            <p className="text-sm text-gray-500 mb-6 leading-relaxed">
              本合同已完成“电子指纹”加密，相关元数据已同步至司法区块链节点，具备完整法律证据效力。
            </p>
            <button 
              onClick={() => {}} 
              className="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 transition-colors"
            >
              下载已签署 PDF
            </button>
          </div>
        </div>
      )}
    </div>
  );
}