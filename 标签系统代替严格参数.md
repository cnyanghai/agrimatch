# æ–¹æ¡ˆä¸‰ï¼šæ ‡ç­¾ç³»ç»Ÿä»£æ›¿ä¸¥æ ¼å‚æ•° - è¯¦ç»†è®²è§£

## ğŸ¯ è®¾è®¡ç†å¿µ

**æ ¸å¿ƒæ€æƒ³**ï¼šå°†å›ºå®šçš„å‚æ•°ç»“æ„ï¼ˆå“ç±» â†’ å‚æ•° â†’ å€¼ï¼‰æ”¹ä¸ºçµæ´»çš„æ ‡ç­¾ä½“ç³»ï¼ˆæ ‡ç­¾ + å€¼çš„ç»„åˆï¼‰ï¼Œç”¨æˆ·å¯ä»¥è‡ªç”±é€‰æ‹©ã€ç»„åˆæ ‡ç­¾æ¥è¡¨è¾¾äº§å“ç‰¹æ€§ã€‚

**å¯¹æ¯”ä¼ ç»Ÿå‚æ•°ç³»ç»Ÿ**ï¼š

| ä¼ ç»Ÿå‚æ•°ç³»ç»Ÿ | æ ‡ç­¾ç³»ç»Ÿ |
|------------|---------|
| å›ºå®šå­—æ®µç»“æ„ | åŠ¨æ€æ ‡ç­¾ç»„åˆ |
| é¢„è®¾å‚æ•°å¿…å¡« | å¯é€‰æ ‡ç­¾è‡ªç”±ç»„åˆ |
| ä¿®æ”¹éœ€è¦æ”¹è¡¨ç»“æ„ | æ–°æ ‡ç­¾éšæ—¶æ·»åŠ  |
| éš¾ä»¥è¡¨è¾¾ç‰¹æ®Šéœ€æ±‚ | æ”¯æŒä»»æ„è‡ªå®šä¹‰æ ‡ç­¾ |

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. æ ‡ç­¾åŸºç¡€è¡¨ï¼ˆnht_tagsï¼‰

```sql
CREATE TABLE `nht_tags` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT 'æ ‡ç­¾ID',
  `tag_name` VARCHAR(50) NOT NULL COMMENT 'æ ‡ç­¾åç§°',
  `tag_key` VARCHAR(50) NOT NULL COMMENT 'æ ‡ç­¾é”®ï¼ˆç”¨äºä»£ç è¯†åˆ«ï¼‰',
  `tag_type` TINYINT NOT NULL DEFAULT 0 COMMENT 'æ ‡ç­¾ç±»å‹ï¼š0-æ–‡æœ¬æ ‡ç­¾ 1-æ•°å€¼æ ‡ç­¾ 2-é€‰é¡¹æ ‡ç­¾ 3-èŒƒå›´æ ‡ç­¾',
  `tag_category` VARCHAR(50) DEFAULT NULL COMMENT 'æ ‡ç­¾åˆ†ç±»ï¼šåŸºç¡€/è´¨é‡/äº§åœ°/åŒ…è£…ç­‰',
  `recommend_product_ids` TEXT COMMENT 'æ¨èç»™çš„äº§å“IDåˆ—è¡¨ï¼ˆJSONæ•°ç»„ï¼‰',
  `options` TEXT COMMENT 'é€‰é¡¹å€¼ï¼ˆJSONæ•°ç»„ï¼Œä»…é€‰é¡¹æ ‡ç­¾ä½¿ç”¨ï¼‰',
  `unit` VARCHAR(20) DEFAULT NULL COMMENT 'å•ä½ï¼ˆæ•°å€¼æ ‡ç­¾ä½¿ç”¨ï¼‰',
  `min_value` DECIMAL(10,2) DEFAULT NULL COMMENT 'æœ€å°å€¼ï¼ˆæ•°å€¼æ ‡ç­¾ä½¿ç”¨ï¼‰',
  `max_value` DECIMAL(10,2) DEFAULT NULL COMMENT 'æœ€å¤§å€¼ï¼ˆæ•°å€¼æ ‡ç­¾ä½¿ç”¨ï¼‰',
  `default_value` VARCHAR(100) DEFAULT NULL COMMENT 'é»˜è®¤å€¼',
  `sort` INT DEFAULT 0 COMMENT 'æ’åºæƒé‡',
  `is_hot` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦çƒ­é—¨æ ‡ç­¾ï¼š0-å¦ 1-æ˜¯',
  `is_required` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å¿…å¡«ï¼š0-å¦ 1-æ˜¯',
  `status` TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š0-ç¦ç”¨ 1-å¯ç”¨',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_tag_key` (`tag_key`),
  KEY `idx_tag_type` (`tag_type`),
  KEY `idx_product_recommend` (`recommend_product_ids`(255))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ ‡ç­¾å®šä¹‰è¡¨';
```

### 2. é‡‡è´­éœ€æ±‚-æ ‡ç­¾å…³è”è¡¨ï¼ˆbus_requirement_tagsï¼‰

```sql
CREATE TABLE `bus_requirement_tags` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `requirement_id` BIGINT NOT NULL COMMENT 'é‡‡è´­éœ€æ±‚ID',
  `tag_id` INT NOT NULL COMMENT 'æ ‡ç­¾ID',
  `tag_value` VARCHAR(500) DEFAULT NULL COMMENT 'æ ‡ç­¾å€¼ï¼ˆæ–‡æœ¬/é€‰é¡¹æ ‡ç­¾ä½¿ç”¨ï¼‰',
  `tag_number` DECIMAL(10,2) DEFAULT NULL COMMENT 'æ ‡ç­¾æ•°å€¼ï¼ˆæ•°å€¼æ ‡ç­¾ä½¿ç”¨ï¼‰',
  `tag_range` VARCHAR(100) DEFAULT NULL COMMENT 'æ ‡ç­¾èŒƒå›´ï¼ˆèŒƒå›´æ ‡ç­¾ä½¿ç”¨ï¼Œå¦‚ "â‰¥14.0"ï¼‰',
  `sort` INT DEFAULT 0 COMMENT 'æ’åº',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_requirement_tag` (`requirement_id`, `tag_id`),
  KEY `idx_tag_id` (`tag_id`),
  KEY `idx_requirement_id` (`requirement_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é‡‡è´­éœ€æ±‚æ ‡ç­¾å…³è”è¡¨';
```

### 3. ä¾›åº”ä¿¡æ¯-æ ‡ç­¾å…³è”è¡¨ï¼ˆbus_supply_tagsï¼‰

```sql
CREATE TABLE `bus_supply_tags` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `supply_id` BIGINT NOT NULL COMMENT 'ä¾›åº”ä¿¡æ¯ID',
  `tag_id` INT NOT NULL COMMENT 'æ ‡ç­¾ID',
  `tag_value` VARCHAR(500) DEFAULT NULL COMMENT 'æ ‡ç­¾å€¼',
  `tag_number` DECIMAL(10,2) DEFAULT NULL COMMENT 'æ ‡ç­¾æ•°å€¼',
  `tag_range` VARCHAR(100) DEFAULT NULL COMMENT 'æ ‡ç­¾èŒƒå›´',
  `sort` INT DEFAULT 0 COMMENT 'æ’åº',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_supply_tag` (`supply_id`, `tag_id`),
  KEY `idx_tag_id` (`tag_id`),
  KEY `idx_supply_id` (`supply_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä¾›åº”ä¿¡æ¯æ ‡ç­¾å…³è”è¡¨';
```

### 4. åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®

```sql
-- åŸºç¡€æ ‡ç­¾ï¼ˆé€‚ç”¨äºå¤šä¸ªå“ç±»ï¼‰
INSERT INTO `nht_tags` (`tag_name`, `tag_key`, `tag_type`, `tag_category`, `recommend_product_ids`, `is_hot`, `sort`) VALUES
('äº§åœ°', 'origin', 0, 'åŸºç¡€', '[1,2,3,4,5]', 1, 1),
('å¹´ä»½', 'year', 0, 'åŸºç¡€', '[1,2,3,4,5]', 1, 2),
('å“ç‰Œ', 'brand', 0, 'åŸºç¡€', '[1,2,3,4,5]', 0, 3),
('è®¤è¯', 'certification', 2, 'åŸºç¡€', '[1,2,3,4,5]', 0, 4);

-- è´¨é‡æ ‡ç­¾ï¼ˆæ•°å€¼å‹ï¼‰
INSERT INTO `nht_tags` (`tag_name`, `tag_key`, `tag_type`, `tag_category`, `recommend_product_ids`, `unit`, `is_hot`, `sort`) VALUES
('æ°´åˆ†', 'moisture', 1, 'è´¨é‡', '[1,2,3,4,5]', '%', 1, 10),
('åƒç²’é‡', 'thousand_grain_weight', 1, 'è´¨é‡', '[1,2]', 'g', 0, 11),
('ç²—è›‹ç™½', 'crude_protein', 1, 'è´¨é‡', '[1,2]', '%', 0, 12),
('ç²—çº¤ç»´', 'crude_fiber', 1, 'è´¨é‡', '[1,2]', '%', 0, 13),
('ç²—ç°åˆ†', 'crude_ash', 1, 'è´¨é‡', '[1,2]', '%', 0, 14),
('é…¸ä»·', 'acid_value', 1, 'è´¨é‡', '[6,7,8]', 'mg/g', 0, 15),
('è¿‡æ°§åŒ–å€¼', 'peroxide_value', 1, 'è´¨é‡', '[6,7,8]', 'mmol/kg', 0, 16);

-- åŒ…è£…æ ‡ç­¾ï¼ˆé€‰é¡¹å‹ï¼‰
INSERT INTO `nht_tags` (`tag_name`, `tag_key`, `tag_type`, `tag_category`, `recommend_product_ids`, `options`, `sort`) VALUES
('åŒ…è£…æ–¹å¼', 'packaging', 2, 'åŒ…è£…', '[1,2,3,4,5]', '["æ•£è£…","è¢‹è£…","ç®±è£…","æ¡¶è£…"]', 20),
('åŒ…è£…è§„æ ¼', 'packaging_spec', 2, 'åŒ…è£…', '[1,2,3,4,5]', '["25kg/è¢‹","50kg/è¢‹","1000kg/å¨åŒ…","å®šåˆ¶"]', 21);

-- è®¤è¯é€‰é¡¹æ•°æ®
UPDATE `nht_tags` SET `options` = '["æœ‰æœºè®¤è¯","ç»¿è‰²é£Ÿå“è®¤è¯","æ— å…¬å®³è®¤è¯","ISO9001","HACCP","éè½¬åŸºå› "]' WHERE `tag_key` = 'certification';

-- èŒƒå›´æ ‡ç­¾ï¼ˆç”¨äºè´¨é‡è¦æ±‚ï¼‰
INSERT INTO `nht_tags` (`tag_name`, `tag_key`, `tag_type`, `tag_category`, `recommend_product_ids`, `unit`, `sort`) VALUES
('æ°´åˆ†è¦æ±‚', 'moisture_requirement', 3, 'è´¨é‡è¦æ±‚', '[1,2,3,4,5]', '%', 30),
('åƒç²’é‡è¦æ±‚', 'grain_weight_requirement', 3, 'è´¨é‡è¦æ±‚', '[1,2]', 'g', 31),
('éœ‰å˜ç²’è¦æ±‚', 'mold_requirement', 3, 'è´¨é‡è¦æ±‚', '[1,2,3,4,5]', '%', 32);
```

---

## ğŸ¨ å‰ç«¯å®ç°

### 1. æ ‡ç­¾ç›¸å…³ API å®šä¹‰

```typescript
// frontend/src/api/tag.ts
import { http } from './http'
import type { Result } from './types'

export interface Tag {
  id: number
  tagName: string
  tagKey: string
  tagType: number // 0-æ–‡æœ¬ 1-æ•°å€¼ 2-é€‰é¡¹ 3-èŒƒå›´
  tagCategory?: string
  recommendProductIds?: number[]
  options?: string[]
  unit?: string
  minValue?: number
  maxValue?: number
  defaultValue?: string
  sort: number
  isHot: boolean
  isRequired: boolean
  status: number
}

export interface TagValue {
  tagId: number
  tagValue?: string
  tagNumber?: number
  tagRange?: string
  sort?: number
}

// æ ¹æ®äº§å“IDè·å–æ¨èæ ‡ç­¾
export async function getTagsByProduct(productId: number) {
  const { data } = await http.get<Result<Tag[]>>(`/api/tags/product/${productId}`)
  return data
}

// è·å–æ‰€æœ‰çƒ­é—¨æ ‡ç­¾
export async function getHotTags() {
  const { data } = await http.get<Result<Tag[]>>('/api/tags/hot')
  return data
}

// è·å–æ ‡ç­¾åˆ†ç±»åˆ—è¡¨
export async function getTagCategories() {
  const { data } = await http.get<Result<string[]>>('/api/tags/categories')
  return data
}

// æœç´¢æ ‡ç­¾ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
export async function searchTags(keyword: string) {
  const { data } = await http.get<Result<Tag[]>>('/api/tags/search', { params: { keyword } })
  return data
}
```

### 2. æ ‡ç­¾é€‰æ‹©å™¨ç»„ä»¶ï¼ˆTagPicker.vueï¼‰

```vue
<script setup lang="ts">
import { ref, computed, watch, onMounted } from 'vue'
import { Plus, X, Search, Tag as TagIcon, ChevronDown } from 'lucide-vue-next'
import { getTagsByProduct, getHotTags, searchTags, type Tag } from '../api/tag'

interface TagValue {
  tagId: number
  tagName: string
  tagKey: string
  tagType: number
  tagValue?: string
  tagNumber?: number
  tagRange?: string
  unit?: string
  options?: string[]
}

const props = defineProps<{
  productId?: number
  modelValue: TagValue[]
  maxTags?: number
}>()

const emit = defineEmits<{
  'update:modelValue': [value: TagValue[]]
}>()

// é€‰ä¸­çš„æ ‡ç­¾
const selectedTags = ref<TagValue[]>([...props.modelValue])

// æ¨èæ ‡ç­¾
const recommendedTags = ref<Tag[]>([])

// çƒ­é—¨æ ‡ç­¾
const hotTags = ref<Tag[]>([])

// æœç´¢å…³é”®è¯
const searchKeyword = ref('')

// æœç´¢ç»“æœ
const searchResults = ref<Tag[]>([])

// å½“å‰å±•å¼€çš„åˆ†ç±»
const expandedCategory = ref<string>('all')

// è‡ªå®šä¹‰æ ‡ç­¾è¾“å…¥æ¡†æ˜¾ç¤ºçŠ¶æ€
const showCustomInput = ref(false)
const customTagName = ref('')

// è·å–æŒ‰åˆ†ç±»åˆ†ç»„çš„æ ‡ç­¾
const tagsByCategory = computed(() => {
  const grouped: Record<string, Tag[]> = {}
  const allTags = [...recommendedTags.value]
  
  allTags.forEach(tag => {
    const category = tag.tagCategory || 'å…¶ä»–'
    if (!grouped[category]) {
      grouped[category] = []
    }
    grouped[category].push(tag)
  })
  
  return grouped
})

// åˆ¤æ–­æ ‡ç­¾æ˜¯å¦å·²é€‰ä¸­
const isTagSelected = (tagId: number) => {
  return selectedTags.value.some(t => t.tagId === tagId)
}

// æ·»åŠ æ ‡ç­¾
function addTag(tag: Tag, initialValue?: string | number) {
  if (isTagSelected(tag.id)) {
    return
  }
  
  if (props.maxTags && selectedTags.value.length >= props.maxTags) {
    ElMessage.warning(`æœ€å¤šåªèƒ½é€‰æ‹©${props.maxTags}ä¸ªæ ‡ç­¾`)
    return
  }
  
  const tagValue: TagValue = {
    tagId: tag.id,
    tagName: tag.tagName,
    tagKey: tag.tagKey,
    tagType: tag.tagType,
    unit: tag.unit,
    options: tag.options
  }
  
  // è®¾ç½®åˆå§‹å€¼
  if (initialValue !== undefined) {
    if (tag.tagType === 1) {
      tagValue.tagNumber = initialValue as number
    } else if (tag.tagType === 0 || tag.tagType === 2) {
      tagValue.tagValue = initialValue as string
    }
  } else if (tag.defaultValue) {
    if (tag.tagType === 1) {
      tagValue.tagNumber = parseFloat(tag.defaultValue)
    } else {
      tagValue.tagValue = tag.defaultValue
    }
  }
  
  selectedTags.value.push(tagValue)
  emitChange()
}

// åˆ é™¤æ ‡ç­¾
function removeTag(tagId: number) {
  const index = selectedTags.value.findIndex(t => t.tagId === tagId)
  if (index > -1) {
    selectedTags.value.splice(index, 1)
    emitChange()
  }
}

// æ›´æ–°æ ‡ç­¾å€¼
function updateTagValue(tagValue: TagValue, value: any) {
  const tag = selectedTags.value.find(t => t.tagId === tagValue.tagId)
  if (tag) {
    if (tagValue.tagType === 1) {
      tag.tagNumber = value
    } else if (tagValue.tagType === 0 || tagValue.tagType === 2) {
      tag.tagValue = value
    }
    emitChange()
  }
}

// æ›´æ–°èŒƒå›´æ ‡ç­¾
function updateTagRange(tagValue: TagValue, range: string) {
  const tag = selectedTags.value.find(t => t.tagId === tagValue.tagId)
  if (tag) {
    tag.tagRange = range
    emitChange()
  }
}

// æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
function addCustomTag() {
  if (!customTagName.value.trim()) {
    return
  }
  
  // è¿™é‡Œåº”è¯¥è°ƒç”¨APIåˆ›å»ºæ–°æ ‡ç­¾ï¼Œç®€åŒ–å¤„ç†ç›´æ¥ä½¿ç”¨
  const customTag: TagValue = {
    tagId: 0, // 0è¡¨ç¤ºè‡ªå®šä¹‰æ ‡ç­¾
    tagName: customTagName.value,
    tagKey: customTagName.value.toLowerCase().replace(/\s+/g, '_'),
    tagType: 0,
    tagValue: ''
  }
  
  selectedTags.value.push(customTag)
  customTagName.value = ''
  showCustomInput.value = false
  emitChange()
}

// æœç´¢æ ‡ç­¾
async function handleSearch() {
  if (!searchKeyword.value.trim()) {
    searchResults.value = []
    return
  }
  
  const res = await searchTags(searchKeyword.value)
  if (res.code === 0) {
    searchResults.value = res.data || []
  }
}

// åŠ è½½æ¨èæ ‡ç­¾
async function loadRecommendedTags() {
  if (!props.productId) return
  
  const res = await getTagsByProduct(props.productId)
  if (res.code === 0) {
    recommendedTags.value = res.data || []
  }
}

// åŠ è½½çƒ­é—¨æ ‡ç­¾
async function loadHotTags() {
  const res = await getHotTags()
  if (res.code === 0) {
    hotTags.value = res.data || []
  }
}

// å‘å‡ºå˜åŒ–äº‹ä»¶
function emitChange() {
  emit('update:modelValue', [...selectedTags.value])
}

// ç›‘å¬ modelValue å˜åŒ–
watch(() => props.modelValue, (newVal) => {
  selectedTags.value = [...newVal]
}, { deep: true })

onMounted(async () => {
  await Promise.all([
    loadRecommendedTags(),
    loadHotTags()
  ])
})
</script>

<template>
  <div class="tag-picker">
    <!-- å·²é€‰æ ‡ç­¾ -->
    <div v-if="selectedTags.length > 0" class="selected-tags mb-4">
      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
        å·²é€‰æ ‡ç­¾ ({{ selectedTags.length }})
      </div>
      <div class="flex flex-wrap gap-2">
        <div
          v-for="tagValue in selectedTags"
          :key="tagValue.tagId"
          class="inline-flex items-center gap-2 px-3 py-1.5 bg-brand-50 text-brand-700 rounded-lg border border-brand-200"
        >
          <TagIcon class="w-3.5 h-3.5" />
          <span class="text-sm font-medium">{{ tagValue.tagName }}</span>
          
          <!-- æ–‡æœ¬æ ‡ç­¾å€¼è¾“å…¥ -->
          <template v-if="tagValue.tagType === 0 && !tagValue.tagValue">
            <input
              v-model="tagValue.tagValue"
              type="text"
              placeholder="è¾“å…¥å€¼"
              class="w-20 px-2 py-0.5 text-sm bg-white border border-gray-200 rounded focus:outline-none focus:border-brand-500"
              @click.stop
            />
          </template>
          
          <!-- æ•°å€¼æ ‡ç­¾å€¼è¾“å…¥ -->
          <template v-if="tagValue.tagType === 1">
            <input
              :value="tagValue.tagNumber"
              type="number"
              :placeholder="'è¾“å…¥å€¼' + (tagValue.unit ? `(${tagValue.unit})` : '')"
              class="w-24 px-2 py-0.5 text-sm bg-white border border-gray-200 rounded focus:outline-none focus:border-brand-500"
              @input="updateTagValue(tagValue, $event.target.value)"
              @click.stop
            />
            <span v-if="tagValue.unit" class="text-xs text-gray-500">{{ tagValue.unit }}</span>
          </template>
          
          <!-- é€‰é¡¹æ ‡ç­¾é€‰æ‹© -->
          <template v-if="tagValue.tagType === 2 && tagValue.options">
            <select
              :value="tagValue.tagValue"
              class="px-2 py-0.5 text-sm bg-white border border-gray-200 rounded focus:outline-none focus:border-brand-500"
              @change="updateTagValue(tagValue, $event.target.value)"
              @click.stop
            >
              <option value="">é€‰æ‹©</option>
              <option v-for="option in tagValue.options" :key="option" :value="option">
                {{ option }}
              </option>
            </select>
          </template>
          
          <!-- èŒƒå›´æ ‡ç­¾è¾“å…¥ -->
          <template v-if="tagValue.tagType === 3">
            <select
              :value="tagValue.tagRange"
              class="px-2 py-0.5 text-sm bg-white border border-gray-200 rounded focus:outline-none focus:border-brand-500"
              @change="updateTagRange(tagValue, $event.target.value)"
              @click.stop
            >
              <option value="">é€‰æ‹©èŒƒå›´</option>
              <option :value="`â‰¥0`">â‰¥0{{ tagValue.unit }}</option>
              <option :value="`â‰¤10`">â‰¤10{{ tagValue.unit }}</option>
              <option :value="`â‰¤14.0`">â‰¤14.0{{ tagValue.unit }}</option>
              <option :value="`â‰¤14.5`">â‰¤14.5{{ tagValue.unit }}</option>
              <option :value="`â‰¤15.0`">â‰¤15.0{{ tagValue.unit }}</option>
            </select>
          </template>
          
          <!-- æ˜¾ç¤ºå·²è®¾ç½®çš„å€¼ -->
          <template v-if="tagValue.tagValue && tagValue.tagType !== 1">
            <span class="text-xs text-gray-500">: {{ tagValue.tagValue }}</span>
          </template>
          
          <button
            @click="removeTag(tagValue.tagId)"
            class="p-0.5 hover:bg-brand-200 rounded transition-colors"
          >
            <X class="w-3.5 h-3.5" />
          </button>
        </div>
      </div>
    </div>

    <!-- æœç´¢æ ‡ç­¾ -->
    <div class="search-box mb-4">
      <div class="relative">
        <Search class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
        <input
          v-model="searchKeyword"
          type="text"
          placeholder="æœç´¢æ ‡ç­¾..."
          class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-brand-500"
          @input="handleSearch"
        />
      </div>
      
      <!-- æœç´¢ç»“æœ -->
      <div v-if="searchResults.length > 0" class="mt-2 p-2 bg-white border border-gray-200 rounded-lg shadow-sm">
        <div
          v-for="tag in searchResults"
          :key="tag.id"
          class="px-3 py-2 hover:bg-gray-50 rounded cursor-pointer flex items-center justify-between"
          @click="addTag(tag)"
        >
          <span class="text-sm">{{ tag.tagName }}</span>
          <span v-if="tag.isHot" class="text-[10px] px-1.5 py-0.5 bg-red-100 text-red-600 rounded">çƒ­é—¨</span>
        </div>
      </div>
    </div>

    <!-- åˆ†ç±»æ ‡ç­¾ -->
    <div v-if="Object.keys(tagsByCategory).length > 0" class="category-tags">
      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
        æ¨èæ ‡ç­¾
      </div>
      
      <div v-for="(tags, category) in tagsByCategory" :key="category" class="mb-3">
        <div
          class="flex items-center justify-between cursor-pointer py-1"
          @click="expandedCategory = expandedCategory === category ? 'all' : category"
        >
          <span class="text-sm font-medium text-gray-700">{{ category }}</span>
          <ChevronDown
            :class="['w-4 h-4 text-gray-400 transition-transform', expandedCategory === category ? 'rotate-180' : '']"
          />
        </div>
        
        <div v-show="expandedCategory === category || expandedCategory === 'all'" class="mt-2 flex flex-wrap gap-2">
          <button
            v-for="tag in tags"
            :key="tag.id"
            :class="[
              'px-3 py-1.5 rounded-lg text-sm font-medium border transition-all',
              isTagSelected(tag.id)
                ? 'bg-brand-500 text-white border-brand-500'
                : 'bg-white text-gray-600 border-gray-200 hover:border-brand-300 hover:text-brand-600'
            ]"
            @click="addTag(tag)"
          >
            {{ tag.tagName }}
            <span v-if="tag.isHot" class="ml-1 text-[10px]">ğŸ”¥</span>
          </button>
        </div>
      </div>
    </div>

    <!-- çƒ­é—¨æ ‡ç­¾ -->
    <div v-if="hotTags.length > 0" class="hot-tags mt-4">
      <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
        çƒ­é—¨æ ‡ç­¾
      </div>
      <div class="flex flex-wrap gap-2">
        <button
          v-for="tag in hotTags"
          :key="tag.id"
          :class="[
            'px-3 py-1.5 rounded-lg text-sm font-medium border transition-all',
            isTagSelected(tag.id)
              ? 'bg-brand-500 text-white border-brand-500'
              : 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100'
          ]"
          @click="addTag(tag)"
        >
          {{ tag.tagName }}
        </button>
      </div>
    </div>

    <!-- æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾ -->
    <div class="custom-tag mt-4">
      <button
        v-if="!showCustomInput"
        @click="showCustomInput = true"
        class="text-sm text-brand-600 hover:text-brand-700 flex items-center gap-1"
      >
        <Plus class="w-4 h-4" />
        æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
      </button>
      
      <div v-else class="flex gap-2">
        <input
          v-model="customTagName"
          type="text"
          placeholder="è¾“å…¥æ ‡ç­¾åç§°"
          class="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:border-brand-500"
          @keyup.enter="addCustomTag"
        />
        <button
          @click="addCustomTag"
          class="px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700"
        >
          æ·»åŠ 
        </button>
        <button
          @click="showCustomInput = false; customTagName = ''"
          class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200"
        >
          å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>
</template>

<style scoped>
.tag-picker {
  /* è‡ªå®šä¹‰æ ·å¼ */
}
</style>
```

### 3. åœ¨å‘å¸ƒé¡µé¢ä¸­ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨

```vue
<!-- MyPurchaseManageView.vue ç‰‡æ®µ -->
<script setup lang="ts">
import { ref } from 'vue'
import TagPicker from '../components/TagPicker.vue'
import type { TagValue } from '../api/tag'

const publishForm = ref({
  categoryId: undefined,
  categoryName: '',
  quantity: undefined,
  // ... å…¶ä»–å­—æ®µ
})

// æ ‡ç­¾å€¼
const tagValues = ref<TagValue[]>([])

// æ„å»ºæ ‡ç­¾JSONç”¨äºæäº¤
function buildTagsJson() {
  return JSON.stringify(tagValues.value.map(tv => ({
    tagId: tv.tagId,
    tagName: tv.tagName,
    tagKey: tv.tagKey,
    tagValue: tv.tagValue,
    tagNumber: tv.tagNumber,
    tagRange: tv.tagRange
  })))
}

async function publishRequirement() {
  const tagsJson = buildTagsJson()
  
  const req = {
    categoryName: publishForm.value.categoryName,
    quantity: publishForm.value.quantity,
    tagsJson,  // æ›¿ä»£åŸæ¥çš„ paramsJson
    // ... å…¶ä»–å­—æ®µ
  }
  
  // æäº¤è¯·æ±‚...
}
</script>

<template>
  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
    <div class="p-5 border-b border-gray-200">
      <h3 class="text-2xl font-bold text-gray-900">äº§å“æ ‡ç­¾</h3>
      <p class="text-sm text-gray-500 mt-1">é€‰æ‹©æ ‡ç­¾æè¿°æ‚¨çš„äº§å“ç‰¹æ€§ï¼Œæ–¹ä¾¿å…¶ä»–ç”¨æˆ·å¿«é€Ÿäº†è§£</p>
    </div>
    <div class="p-5">
      <TagPicker
        v-model="tagValues"
        :product-id="publishForm.categoryId"
        :max-tags="20"
      />
    </div>
  </div>
</template>
```

---

## ğŸ”§ åç«¯å®ç°

### 1. æ ‡ç­¾å®ä½“ç±»

```java
// Tag.java
package com.agrimatch.tag.entity;

import lombok.Data;
import java.time.LocalDateTime;

@Data
public class Tag {
    private Integer id;
    private String tagName;
    private String tagKey;
    private Integer tagType; // 0-æ–‡æœ¬ 1-æ•°å€¼ 2-é€‰é¡¹ 3-èŒƒå›´
    private String tagCategory;
    private String recommendProductIds; // JSONæ•°ç»„
    private String options; // JSONæ•°ç»„
    private String unit;
    private Double minValue;
    private Double maxValue;
    private String defaultValue;
    private Integer sort;
    private Boolean isHot;
    private Boolean isRequired;
    private Integer status;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
```

### 2. æ ‡ç­¾Mapper

```java
// TagMapper.java
package com.agrimatch.tag.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.agrimatch.tag.entity.Tag;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;
import java.util.List;

@Mapper
public interface TagMapper extends BaseMapper<Tag> {
    
    @Select("SELECT * FROM nht_tags WHERE FIND_IN_SET(#{productId}, recommend_product_ids) AND status = 1 ORDER BY sort ASC")
    List<Tag> findByProductId(@Param("productId") Integer productId);
    
    @Select("SELECT * FROM nht_tags WHERE is_hot = 1 AND status = 1 ORDER BY sort ASC")
    List<Tag> findHotTags();
    
    @Select("SELECT DISTINCT tag_category FROM nht_tags WHERE tag_category IS NOT NULL AND status = 1 ORDER BY tag_category")
    List<String> findCategories();
    
    @Select("SELECT * FROM nht_tags WHERE tag_name LIKE CONCAT('%', #{keyword}, '%') AND status = 1 ORDER BY sort ASC")
    List<Tag> searchByKeyword(@Param("keyword") String keyword);
}
```

### 3. æ ‡ç­¾Service

```java
// TagService.java
package com.agrimatch.tag.service;

import com.agrimatch.tag.entity.Tag;
import com.agrimatch.tag.mapper.TagMapper;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import java.util.*;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class TagService {
    
    private final TagMapper tagMapper;
    private final ObjectMapper objectMapper;
    
    public List<Tag> getTagsByProduct(Integer productId) {
        List<Tag> tags = tagMapper.findByProductId(productId);
        return tags.stream()
                .peek(this::parseJsonFields)
                .collect(Collectors.toList());
    }
    
    public List<Tag> getHotTags() {
        List<Tag> tags = tagMapper.findHotTags();
        return tags.stream()
                .peek(this::parseJsonFields)
                .collect(Collectors.toList());
    }
    
    public List<String> getTagCategories() {
        return tagMapper.findCategories();
    }
    
    public List<Tag> searchTags(String keyword) {
        List<Tag> tags = tagMapper.searchByKeyword(keyword);
        return tags.stream()
                .peek(this::parseJsonFields)
                .collect(Collectors.toList());
    }
    
    private void parseJsonFields(Tag tag) {
        try {
            if (tag.getRecommendProductIds() != null) {
                tag.setRecommendProductIds(objectMapper.readValue(
                    tag.getRecommendProductIds(), 
                    new TypeReference<List<Integer>>() {}
                ).toString());
            }
            if (tag.getOptions() != null) {
                tag.setOptions(objectMapper.readValue(
                    tag.getOptions(), 
                    new TypeReference<List<String>>() {}
                ).toString());
            }
        } catch (Exception e) {
            // è§£æå¤±è´¥æ—¶ä¿æŒåŸå€¼
        }
    }
}
```

### 4. æ ‡ç­¾Controller

```java
// TagController.java
package com.agrimatch.tag.controller;

import com.agrimatch.common.Result;
import com.agrimatch.tag.entity.Tag;
import com.agrimatch.tag.service.TagService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;
import java.util.List;

@RestController
@RequestMapping("/api/tags")
@RequiredArgsConstructor
public class TagController {
    
    private final TagService tagService;
    
    @GetMapping("/product/{productId}")
    public Result<List<Tag>> getTagsByProduct(@PathVariable Integer productId) {
        return Result.success(tagService.getTagsByProduct(productId));
    }
    
    @GetMapping("/hot")
    public Result<List<Tag>> getHotTags() {
        return Result.success(tagService.getHotTags());
    }
    
    @GetMapping("/categories")
    public Result<List<String>> getTagCategories() {
        return Result.success(tagService.getTagCategories());
    }
    
    @GetMapping("/search")
    public Result<List<Tag>> searchTags(@RequestParam String keyword) {
        return Result.success(tagService.searchTags(keyword));
    }
}
```

### 5. ä¿®æ”¹éœ€æ±‚/ä¾›åº”å®ä½“ç±»

```java
// Requirement.java - æ·»åŠ  tagsJson å­—æ®µ
public class Requirement {
    // ... ç°æœ‰å­—æ®µ
    
    @TableField("tags_json")
    private String tagsJson;  // æ›¿ä»£åŸæ¥çš„ paramsJson
}
```

---

## ğŸ¯ ä¼˜åŠ¿ä¸æŒ‘æˆ˜

### âœ… ä¼˜åŠ¿

1. **é«˜åº¦çµæ´»**
   - æ–°äº§å“æ— éœ€é¢„å…ˆå®šä¹‰å‚æ•°
   - ç”¨æˆ·å¯è‡ªç”±ç»„åˆè¡¨è¾¾éœ€æ±‚
   - æ”¯æŒä»»æ„è‡ªå®šä¹‰æ ‡ç­¾

2. **æ˜“äºæ‰©å±•**
   - æ·»åŠ æ–°æ ‡ç­¾åªéœ€æ’å…¥æ•°æ®åº“
   - æ— éœ€ä¿®æ”¹è¡¨ç»“æ„
   - çƒ­é—¨æ ‡ç­¾å¯åŠ¨æ€è°ƒæ•´

3. **ç”¨æˆ·å‹å¥½**
   - æ¨èæ ‡ç­¾é™ä½å­¦ä¹ æˆæœ¬
   - æœç´¢åŠŸèƒ½å¿«é€Ÿå®šä½
   - å¯è§†åŒ–æ ‡ç­¾å±•ç¤ºæ¸…æ™°

4. **ä¾¿äºæ£€ç´¢**
   - æ ‡ç­¾å¯å»ºç«‹å€’æ’ç´¢å¼•
   - æ”¯æŒå¤šæ ‡ç­¾ç»„åˆç­›é€‰
   - çƒ­é—¨æ ‡ç­¾å¯åšæ¨è

### âš ï¸ æŒ‘æˆ˜

1. **æ•°æ®ä¸€è‡´æ€§**
   - åŒä¸€æ¦‚å¿µå¯èƒ½æœ‰å¤šç§æ ‡ç­¾è¡¨è¾¾ï¼ˆå¦‚"ä¸œåŒ—ç‰ç±³" vs "äº§è‡ªä¸œåŒ—"ï¼‰
   - éœ€è¦æ ‡ç­¾åˆå¹¶å’Œè§„èŒƒåŒ–æœºåˆ¶

2. **ç”¨æˆ·å­¦ä¹ æˆæœ¬**
   - ç”¨æˆ·éœ€è¦ç†è§£æ ‡ç­¾ç³»ç»Ÿçš„ä½¿ç”¨æ–¹å¼
   - éœ€è¦å¼•å¯¼å’Œç¤ºä¾‹å¸®åŠ©ç”¨æˆ·é€‰æ‹©

3. **è´¨é‡æ§åˆ¶**
   - è‡ªå®šä¹‰æ ‡ç­¾å¯èƒ½åŒ…å«é”™è¯¯ä¿¡æ¯
   - éœ€è¦å®¡æ ¸å’Œçº é”™æœºåˆ¶

4. **æ£€ç´¢æ€§èƒ½**
   - å¤§é‡æ ‡ç­¾å½±å“æŸ¥è¯¢æ•ˆç‡
   - éœ€è¦åˆç†çš„ç´¢å¼•è®¾è®¡

---

## ğŸ“‹ å®æ–½å»ºè®®

### é˜¶æ®µä¸€ï¼šåŸºç¡€åŠŸèƒ½ï¼ˆ2-3å‘¨ï¼‰
1. å®Œæˆæ•°æ®åº“è¡¨è®¾è®¡å’Œåˆå§‹æ•°æ®å¯¼å…¥
2. å®ç°æ ‡ç­¾CRUDåŸºç¡€æ¥å£
3. å¼€å‘TagPickerç»„ä»¶
4. åœ¨å‘å¸ƒé¡µé¢é›†æˆæ ‡ç­¾é€‰æ‹©å™¨

### é˜¶æ®µäºŒï¼šä¼˜åŒ–å®Œå–„ï¼ˆ1-2å‘¨ï¼‰
1. æ·»åŠ æ ‡ç­¾æœç´¢å’Œæ¨èç®—æ³•
2. å®ç°æ ‡ç­¾çƒ­åº¦å’Œæ’åº
3. ä¼˜åŒ–UIäº¤äº’ä½“éªŒ
4. æ·»åŠ æ ‡ç­¾ç®¡ç†åå°

### é˜¶æ®µä¸‰ï¼šé«˜çº§åŠŸèƒ½ï¼ˆ2-4å‘¨ï¼‰
1. æ ‡ç­¾æ™ºèƒ½æ¨èï¼ˆåŸºäºå†å²æ•°æ®ï¼‰
2. æ ‡ç­¾åˆå¹¶å’Œå»é‡
3. æ ‡ç­¾ç»Ÿè®¡åˆ†æ
4. æ ‡ç­¾å¯¼å…¥å¯¼å‡º

---

è¿™ä¸ªæ–¹æ¡ˆä¸‰ç›¸æ¯”ä¼ ç»Ÿå‚æ•°ç³»ç»Ÿå…·æœ‰æ›´é«˜çš„çµæ´»æ€§å’Œæ‰©å±•æ€§ï¼Œé€‚åˆå†œäº§å“äº¤æ˜“å¹³å°è¿™ç§äº§å“ç§ç±»ç¹å¤šã€éœ€æ±‚å¤šæ ·åŒ–çš„åœºæ™¯ã€‚æ‚¨è§‰å¾—è¿™ä¸ªæ–¹æ¡ˆå¦‚ä½•ï¼Ÿéœ€è¦æˆ‘è¿›ä¸€æ­¥è¯¦ç»†è®²è§£æŸä¸ªéƒ¨åˆ†å—ï¼Ÿ